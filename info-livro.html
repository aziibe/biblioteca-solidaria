<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhes do Livro</title>
  <link rel="stylesheet" href="css/detalhes.css" />
</head>

<body>

  <header>
    <h1>游닄 Biblioteca Solid치ria</h1>
    <nav>
      <a href="login.html" id="btn-login">Login</a>
      <a href="catalogo.html" id="btn-catalogo" style="display: none;">Catalago</a>
      <a href="gerenciar-livro.html" id="btn-meus-livros" style="display: none;">Meus Livros</a>
      <a href="solicitacoes.html" id="btn-solicitacoes" style="display: none;">Minhas Solicita칞칫es</a>
      <a href="perfil.html" id="btn-perfil" style="display: none;">Perfil</a>
      <a id="btn-sair" style="display: none;">Sair</a>
    </nav>
  </header>

  <main>
    <h1>Detalhes dos Livros</h1>
    <div id="livros-container"></div>

    <script>
      const accessToken = localStorage.getItem("accessToken");
      const btnLogin = document.getElementById("btn-login");
      const btnSolicitacoes = document.getElementById("btn-solicitacoes");
      const btnDoarLivro = document.getElementById("btn-meus-livros");
      const btnPerfil = document.getElementById("btn-perfil");
      const btnSair = document.getElementById("btn-sair");
      const btnCatalogo = document.getElementById("btn-catalogo");

      if (accessToken) {
        // Usu치rio est치 logado
        btnLogin.style.display = "none";
        btnSolicitacoes.style.display = "inline";
        btnDoarLivro.style.display = "inline";
        btnPerfil.style.display = "inline";
        btnSair.style.display = "inline";
        btnCatalogo.style.display = "inline";
      } else {
        // Usu치rio n칚o est치 logado
        btnLogin.style.display = "inline";
        btnSolicitacoes.style.display = "none";
        btnDoarLivro.style.display = "none";
        btnPerfil.style.display = "none";
        btnSair.style.display = "none";
        btnCatalogo.style.display = "none";
      }

      if (btnSair) {
        btnSair.addEventListener("click", () => {
          localStorage.removeItem("accessToken");
          window.location.href = "login.html";
        });
      }

      const livrosContainer = document.getElementById('livros-container');
      const params = new URLSearchParams(window.location.search);
      const idLivro = params.get('id');

      // Busca o livro da API
      async function buscarLivro() {
        try {
          const resposta = await fetch(`http://127.0.0.1:8000/api/catalog/${idLivro}/`);
          const livro = await resposta.json();
          renderizarLivro(livro);
        } catch (erro) {
          livrosContainer.innerHTML = "<p>Erro ao carregar detalhes do livro.</p>";
          console.error(erro);
        }
      }

      function renderizarLivro(livro) {
        const livroDiv = document.createElement('div');
        livroDiv.classList.add('livro');
        livroDiv.innerHTML = `
        <h2>T칤tulo: ${livro.title}</h2>
        <p><strong>Autor:</strong> ${livro.author}</p>
        <p><strong>Descri칞칚o:</strong> ${livro.description}</p>
        <p><strong>Categoria:</strong> ${livro.category}</p>
        <p><strong>Classifica칞칚o de Faixa Et치ria:</strong> ${livro.classification}</p>
        <p><strong>Status:</strong> ${livro.status === "available" ? "Dispon칤vel" : "Indispon칤vel"}</p>

        <div class="doador-info">
          <h3>Doador</h3>
          <p><strong>Usu치rio:</strong> ${livro.user}</p>
        </div>

        <div class="ponto-coleta">
          <h3>Ponto de Coleta</h3>
          <p><strong>Nome:</strong> ${livro.pickup_point.name}</p>
          <p><strong>Endere칞o:</strong> ${livro.pickup_point.street}, ${livro.pickup_point.number}</p>
          <p><strong>Cidade/Estado:</strong> ${livro.pickup_point.city} - ${livro.pickup_point.state}</p>
          <p><strong>CEP:</strong> ${livro.pickup_point.zip}</p>
        </div>

        <div id="acao-solicitar">
          <button class="solicitar-livro">Solicitar Livro</button>
        </div>
      `;

        livrosContainer.appendChild(livroDiv);

        livroDiv.querySelector('.solicitar-livro').addEventListener('click', async function () {
          const token = localStorage.getItem('accessToken');

          if (!token) {
            window.location.href = 'login.html';
            return;
          }

          try {
            const resposta = await fetch('http://127.0.0.1:8000/api/book_requests/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ book_id: idLivro })
            });

            const dados = await resposta.json();

            if (!resposta.ok) {
              const mensagem = dados.detail || dados[0] || 'Erro ao solicitar o livro';
              throw new Error(mensagem);
            }

            alert(`Solicita칞칚o do livro "${livro.title}" enviada com sucesso!`);
          } catch (erro) {
            alert(`Erro ao solicitar o livro: ${erro.message}`);
            console.error(erro);
          }
        });

      }
      buscarLivro();
    </script>
</body>

</html>