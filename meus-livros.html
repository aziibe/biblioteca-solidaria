<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meus Livros - Biblioteca Solid치ria</title>
  <link rel="stylesheet" href="css/catalogo.css" />
</head>

<body>
  <header>
    <h1>游닄 Biblioteca Solid치ria</h1>
    <nav>
      <a href="login.html" id="btn-login">Login</a>
      <a href="catalogo.html" id="btn-catalogo" style="display: none;">Cat치logo</a>
      <a href="meus-livros.html" id="btn-meus-livros" style="display: none;">Meus Livros</a>
      <a href="solicitacoes.html" id="btn-solicitacoes" style="display: none;">Minhas Solicita칞칫es</a>
      <a href="perfil.html" id="btn-perfil" style="display: none;">Perfil</a>
      <a id="btn-sair" style="display: none;">Sair</a>
    </nav>
  </header>

  <main>
    <h2>游닂 Meus Livros</h2>
    <div class="filtros">
      <label for="filtro-genero">Filtrar por G칡nero:</label>
      <select id="filtro-genero">
        <option value="">Todos</option>
        <option value="science_fiction">Fic칞칚o-Cient칤fica</option>
        <option value="non_fiction">N칚o-Fic칞칚o</option>
        <option value="adventure">Aventura</option>
        <option value="romance">Romance</option>
        <option value="horror">Horror</option>
        <option value="fantasy">Fantasia</option>
      </select>

      <label for="filtro-etaria">Filtrar por Faixa Et치ria:</label>
      <select id="filtro-etaria">
        <option value="">Todas</option>
        <option value="all_ages">Livre</option>
        <option value="10_and_up">10+</option>
        <option value="13_and_up">13+</option>
        <option value="16_and_up">16+</option>
        <option value="18_and_up">18+</option>
      </select>
    </div>

    <div id="livros-container">
      <!-- Bot칚o fixo para adicionar um novo livro -->
      <div class="book-card add-book-card" onclick="window.location.href='adicionar-livro.html'">
        <div class="add-book-info">
          <button class="add-book-button">+</button>
        </div>
      </div>
      <!-- Os livros do usu치rio ser칚o inseridos aqui dinamicamente -->
    </div>
  </main>

  <script>
    const generoSelect = document.getElementById("filtro-genero");
    const etariaSelect = document.getElementById("filtro-etaria");

    const categoriasTraduzidas = {
      fantasy: "Fantasia",
      non_fiction: "N칚o-fic칞칚o",
      adventure: "Aventura",
      romance: "Romance",
      horror: "Horror",
      science_fiction: "Fic칞칚o cient칤fica",
    };

    const classificacoesTraduzidas = {
      "18_and_up": "18+",
      "16_and_up": "16+",
      "13_and_up": "13+",
      "10_and_up": "10+",
      all_ages: "Livre",
    };

    // Fun칞칚o para filtrar os livros
    function filtrarLivros() {
      const genero = generoSelect.value;
      const etaria = etariaSelect.value;
      const livros = document.querySelectorAll(".book-card:not(.add-book-card)");

      livros.forEach((livro) => {
        const generoLivro = livro.dataset.genero || "";
        const faixaEtariaLivro = livro.dataset.etaria || "";

        const generoCond = genero === "" || genero === generoLivro;
        const etariaCond = etaria === "" || etaria === faixaEtariaLivro;

        livro.style.display = generoCond && etariaCond ? "flex" : "none";
      });
    }

    generoSelect.addEventListener("change", filtrarLivros);
    etariaSelect.addEventListener("change", filtrarLivros);

    // Fun칞칚o para carregar os livros do usu치rio logado
    async function carregarLivros() {
      try {
        const response = await fetch("http://127.0.0.1:8000/api/my-books/", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
          },
        });

        if (!response.ok) {
          throw new Error("Erro ao carregar os livros do usu치rio.");
        }

        const livros = await response.json();
        const livrosContainer = document.getElementById("livros-container");

        if (livrosContainer) {
          livros.forEach((livro) => {
            const livroCard = document.createElement("div");
            livroCard.classList.add("book-card");
            livroCard.dataset.genero = livro.category;
            livroCard.dataset.etaria = livro.classification;

            const categoriaTraduzida =
              categoriasTraduzidas[livro.category] || livro.category;
            const classificacaoTraduzida =
              classificacoesTraduzidas[livro.classification] ||
              livro.classification;

            livroCard.innerHTML = `
              <img src="img/livro.png" alt="Capa do livro" class="book-img">
              <div class="book-info">
                <p><strong>T칤tulo:</strong> ${livro.title}</p>
                <p><strong>Autor:</strong> ${livro.author}</p>
                <p><strong>G칡nero:</strong> ${categoriaTraduzida}</p>
                <p><strong>Classifica칞칚o:</strong> ${classificacaoTraduzida}</p>
                <p><strong>Status:</strong> ${livro.status === "available" ? "Dispon칤vel" : "Indispon칤vel"
              }</p>
                <a href="info-livro.html?id=${livro.id}" class="edit-button">Ver Detalhes</a>
              </div>`;
            livrosContainer.appendChild(livroCard);
          });

          // Aplicar os filtros ap칩s carregar os livros
          filtrarLivros();
        }
      } catch (error) {
        console.error("Erro ao carregar livros:", error);
        alert("Erro ao carregar os livros do usu치rio.");
      }
    }

    const accessToken = localStorage.getItem("accessToken");
    const btnLogin = document.getElementById("btn-login");
    const btnSolicitacoes = document.getElementById("btn-solicitacoes");
    const btnDoarLivro = document.getElementById("btn-meus-livros");
    const btnPerfil = document.getElementById("btn-perfil");
    const btnSair = document.getElementById("btn-sair");
    const btnCatalogo = document.getElementById("btn-catalogo");

    if (accessToken) {
      // Usu치rio est치 logado
      btnLogin.style.display = "none";
      btnSolicitacoes.style.display = "inline";
      btnDoarLivro.style.display = "inline";
      btnPerfil.style.display = "inline";
      btnSair.style.display = "inline";
      btnCatalogo.style.display = "inline";
    } else {
      // Usu치rio n칚o est치 logado
      btnLogin.style.display = "inline";
      btnSolicitacoes.style.display = "none";
      btnDoarLivro.style.display = "none";
      btnPerfil.style.display = "none";
      btnSair.style.display = "none";
      btnCatalogo.style.display = "none";
    }

    btnSair.addEventListener("click", () => {
      localStorage.removeItem("accessToken");
      window.location.href = "login.html";
    });

    window.onload = carregarLivros;
  </script>
</body>

</html>