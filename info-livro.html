<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhes do Livro</title>
  <link rel="stylesheet" href="css/detalhes.css" />
</head>

<body>

  <header>
    <h1>üìö Biblioteca Solid√°ria</h1>
    <nav>
      <a href="catalogo.html">Cat√°logo</a>
      <a href="solicitacoes.html">Minhas Solicita√ß√µes</a>
      <a href="gerenciar-livro.html">Doar livro</a>
      <a href="painel-usuario.html">Perfil</a>
    </nav>
  </header>

  <main>
    <h1>Detalhes dos Livros</h1>
    <div id="livros-container"></div>

    <script>
      const livrosContainer = document.getElementById('livros-container');
      const usuarioLogado = false;
      const params = new URLSearchParams(window.location.search);
      const idLivro = params.get('id');

      // Busca o livro da API
      async function buscarLivro() {
        try {
          const resposta = await fetch(`http://127.0.0.1:8000/api/catalog/${idLivro}/`);
          const livro = await resposta.json();
          renderizarLivro(livro);
        } catch (erro) {
          livrosContainer.innerHTML = "<p>Erro ao carregar detalhes do livro.</p>";
          console.error(erro);
        }
      }

      function renderizarLivro(livro) {
        const livroDiv = document.createElement('div');
        livroDiv.classList.add('livro');
        livroDiv.innerHTML = `
        <h2>T√≠tulo: ${livro.title}</h2>
        <p><strong>Autor:</strong> ${livro.author}</p>
        <p><strong>Descri√ß√£o:</strong> ${livro.description}</p>
        <p><strong>Categoria:</strong> ${livro.category}</p>
        <p><strong>Classifica√ß√£o de Faixa Et√°ria:</strong> ${livro.classification}</p>
        <p><strong>Status:</strong> ${livro.status === "available" ? "Dispon√≠vel" : "Indispon√≠vel"}</p>

        <div class="doador-info">
          <h3>Doador</h3>
          <p><strong>Usu√°rio:</strong> ${livro.user}</p>
        </div>

        <div class="ponto-coleta">
          <h3>Ponto de Coleta</h3>
          <p><strong>Nome:</strong> ${livro.pickup_point.name}</p>
          <p><strong>Endere√ßo:</strong> ${livro.pickup_point.street}, ${livro.pickup_point.number}</p>
          <p><strong>Cidade/Estado:</strong> ${livro.pickup_point.city} - ${livro.pickup_point.state}</p>
          <p><strong>CEP:</strong> ${livro.pickup_point.zip}</p>
        </div>

        <div id="acao-solicitar">
          <button class="solicitar-livro">Solicitar Livro</button>
        </div>
      `;

        livrosContainer.appendChild(livroDiv);

        livroDiv.querySelector('.solicitar-livro').addEventListener('click', async function () {
          const token = localStorage.getItem('accessToken');

          if (!token) {
            window.location.href = 'login.html';
            return;
          }

          try {
            const resposta = await fetch('http://127.0.0.1:8000/api/book_requests/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ book_id: idLivro })
            });

            const dados = await resposta.json();

            if (!resposta.ok) {
              const mensagem = dados.detail || dados[0] || 'Erro ao solicitar o livro';
              throw new Error(mensagem);
            }

            alert(`Solicita√ß√£o do livro "${livro.title}" enviada com sucesso!`);
          } catch (erro) {
            alert(`Erro ao solicitar o livro: ${erro.message}`);
            console.error(erro);
          }
        });

      }
      buscarLivro();
    </script>
</body>

</html>